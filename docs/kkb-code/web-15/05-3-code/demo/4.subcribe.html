<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  
</body>
<script>
  class Dep{
    constructor() {
      this.subs = []
    }
    addSub(sub) {
      this.subs.push(sub)
    }
    notify(newValue) {
      this.subs.forEach(sub => {
        sub.update(newValue)
      })
    }
  }

  class Watch{
    constructor(data, key, cb) {
      this.cb = cb;
      Dep.target = this
      data[key]; // 出发get
      Dep.target = null

    }
    update(newValue) {
      this.cb(newValue)
    }
  }
  let deps = []
  function observer(data) {
    Object.keys(data).forEach(key => {
      let value = data[key]
      let dep = new Dep()
      deps.push(dep)
      Object.defineProperty(data,key, {
        configurable: true,
        enumerable: true,
        get() {
          console.log('get:',value)
          if(Dep.target) {
            dep.addSub(Dep.target)
          }
          return value
        },
        set(newValue) {
          console.log('set:',newValue)
          dep.notify(newValue)
          value = newValue
        }
      })
    })
  }

  let data = {
    name: '张三',
    age: 22
  }
  observer(data)

  for(let key in data) {
    new Watch(data,key,(newValue) => {
      console.log('获得了更新：',newValue)
    })
  }

  data.name;
  setTimeout(() =>{
    data.name = '李四';
    console.log(deps);
  },1000)
</script>
</html>