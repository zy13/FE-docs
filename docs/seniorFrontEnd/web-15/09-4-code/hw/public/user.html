<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>用户信息</title>
	<link rel="stylesheet" href="/public/assets/css/user.css">
</head>
<body>

<header>
	<button class="btn">上传</button>
	<button class='login-out'>退出</button>
	<input type="file" id="upload" style="display: none;" />
</header>

<div class="content-list"></div>

<div class="task_panel">
	<div class="task_header">
		<h4>当前任务：1/3</h4>
		<span class="icon all-close"></span>
	</div>
	<ul class="task_body"></ul>
</div>
<script>
  // 获取图片数据
  getPhotos(); 

  // 触发选择文件
  let btn = document.querySelector('.btn');
  btn.onclick = function() {
    inputUpload.click();
  }

  // 文件上传
  let inputUpload = document.querySelector('#upload');
  inputUpload.onchange = function() {
    open() // 打开上传窗口
    let xhr = new XMLHttpRequest();
    xhr.open('post','/upload', true);
    
    let fd = new FormData();
    fd.append('attachment', this.files[0]);

		xhr.setRequestHeader('Authorization', `Bearer ${localStorage.getItem('token')}`)
    xhr.send(fd); // 发送请求

    // 创建li
    let li = document.createElement('li');
    li.innerHTML = `<span>任务一</span>
			<div class="task-progress-status">0%</div>
			<div class="progress" style="width:0%"></div>`;
    document.querySelector('.task_body').appendChild(li);

    // 上传进度
    xhr.upload.onprogress = function (e) {
      let v = (e.loaded / e.total * 100).toFixed(2);
      let status = li.children[1];
      let progress = li.children[2];
      status.innerHTML = progress.style.width = `${v}%`;
    }

    // 上传成功
    xhr.onload = function() {
      renderDom(xhr.responseText);
      close();
    }
  }

  // 获取图片接口请求
  function getPhotos() {
    let xhr = new XMLHttpRequest();
    xhr.open('get','/getPhotos', true);
		xhr.setRequestHeader('Authorization',`Bearer ${localStorage.getItem('token')}`)
    xhr.send();
    xhr.onload = function() {
      let res = JSON.parse(xhr.responseText);
			console.log(999, res)
      res.forEach(item => {
        if(item.path) {
          renderDom(item.path.replace('public\\', ''));
        }
      })
    }
  }

  // 渲染图片
  function renderDom(src) {
    let contentList = document.querySelector('.content-list');
    let img = new Image();
    img.src = src;
    img.width = img.height = '100';
    contentList.appendChild(img);
  }

  // 关闭上传窗口
  function close() {
    document.querySelector('.task_panel').style.display = 'none';
  }

  // 打开上传窗口
  function open() {
    document.querySelector('.task_panel').style.display = 'block';
  }

	// 退出
	document.querySelector('.login-out').onclick = async () => {
		localStorage.removeItem('token')
		window.location.href = '/public/login.html'
	}
</script>
</body>
</html>