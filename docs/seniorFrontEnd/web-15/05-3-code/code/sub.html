<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Document</title>
</head>

<body>

</body>
<script>
// 管理器：收集订阅者
class Dep {
    constructor() {
        this.subs = [];
    }
    addSub(sub) {
        this.subs.push(sub);
    }
    notify(newValue) { // 
        this.subs.forEach(sub => {
            sub.update(newValue);
        })
    }
}

// 订阅者：提供回调；
class Watcher {
    constructor(data,key,cb) {
        this.cb = cb;
        Dep.target  =  this;
        data[key]; //触发get
        Dep.target  = null;

    }
    update(newValue) {
        this.cb(newValue);
    }
}


let data = {
    myname: "张三",  
    age: 20
}
// 每条数据 会有一个dep --> 收集 watcher
let deps = [];
// 观察者
function Observer(data) {
    let keys = Object.keys(data);
    keys.forEach(key => {
        let value = data[key];
        let dep = new Dep();
        deps.push(dep);
        Object.defineProperty(data, key, {
            configurable: true,
            enumerable: true,
            get() {
                console.log("get..");
                // 收集watch；
                if(Dep.target){
                    dep.addSub(Dep.target);
                }
                return value;
            },
            set(newValue) {
                // 触发watch
                console.log(dep,newValue);
                dep.notify(newValue);
                value = newValue
            }
        })
    })
}

Observer(data);

for(let key in data){
    new Watcher(data,key,(newValue)=>{
        console.log("触发了更新",newValue);
    })
}
setTimeout(()=>{
data.myname = "李四";
console.log(deps);
},1000);

</script>

</html>